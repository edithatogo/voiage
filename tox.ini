# tox.ini for pyVOI

[tox]
envlist =
    py{38,39,310,311,312}  # Test against multiple Python versions
    lint                     # Linting and formatting checks
    typecheck                # Static type checking
    security                 # Security scanning
    docs                     # Build documentation
    coverage_report          # Generate coverage report (can be combined with test runs)
isolated_build = True
skip_missing_interpreters = True

[gh-actions] # For GitHub Actions integration matrix
python =
    3.8: py38
    3.9: py39
    3.10: py310
    3.11: py311
    3.12: py312

[testenv]
description = Run pytest tests with {envname}
# Pass environment variables if needed, e.g., for API keys in tests (avoid for open source)
# passenv = HOME PYTEST_*
# Install dependencies for testing
# extras = dev # Installs [dev] dependencies from pyproject.toml
# If not using extras, list them directly:
deps =
    pytest>=7.0
    pytest-cov>=3.0
    hypothesis>=6.0
    # Add other direct test dependencies if not covered by pyvoi's install_requires
    # For example, if tests need specific versions of numpy, pandas for test data generation
    numpy>=1.20
    pandas>=1.3
    scikit-learn>=1.0 # For EVPPI tests
    # Add pyvoi itself as a dependency to be installed in the venv
    .[all] # Install pyvoi with all its optional dependencies for thorough testing

commands =
    pytest {posargs} # Pass positional arguments to pytest (e.g., for specific test files)

[testenv:lint]
description = Run linters and formatters
# extras = dev # Ensure ruff is installed
deps = ruff==0.1.9 # Match version in pre-commit and pyproject.toml
commands =
    ruff check pyvoi tests --fix --exit-non-zero-on-fix # Lint and auto-fix, exit if fixes were made
    ruff format pyvoi tests --check # Check formatting, exit if not formatted

[testenv:typecheck]
description = Run static type checking with MyPy
# extras = dev # Ensure mypy and stubs are installed
deps =
    mypy>=1.8 # Match version in pre-commit and pyproject.toml
    # Add stubs dependencies as in pre-commit's mypy hook
    numpy>=1.20
    pandas>=1.3
    xarray>=0.19
    scikit-learn>=1.0
    statsmodels>=0.13
    matplotlib>=3.4
    seaborn>=0.11
    typer>=0.9
    pymc>=5.0
    types-setuptools
    # pytest # If you want to type check test files too

commands =
    mypy pyvoi tests --config-file pyproject.toml {posargs}
    # The --config-file might not be needed if MyPy automatically picks up pyproject.toml [tool.mypy]

[testenv:security]
description = Run security analysis with Bandit
# extras = dev # Ensure bandit is installed
deps = bandit>=1.7.6 # Match version in pre-commit
commands =
    bandit -r pyvoi -c pyproject.toml -s B101 {posargs} # Use config from pyproject.toml

[testenv:docs]
description = Build Sphinx documentation
# extras = dev # Ensure sphinx and theme are installed
deps =
    sphinx>=7.0
    sphinx-rtd-theme>=1.0
    sphinx-autodoc-typehints>=1.12
    # Add other docs dependencies (nbsphinx, myst-parser) if used
    # Install pyvoi itself to allow autodoc to import it
    .[all]
commands =
    sphinx-build -W -b html docs docs/_build/html {posargs} # -W: turn warnings into errors
    # sphinx-build -b linkcheck docs docs/_build/linkcheck # Optional: check external links

[testenv:coverage_report]
description = Generate and check code coverage report
# extras = dev # Ensure pytest-cov is installed (usually part of testenv)
deps = coverage>=7.0 # pytest-cov uses coverage.py
commands =
    coverage report -m --fail-under=80 # Show missing lines and fail if below threshold
    coverage xml # Generate XML report for CI/CD systems (e.g., Codecov)
    coverage html -d coverage_html_report # Generate HTML report

# Example of a combined test and coverage environment
# [testenv:py{38,39,310,311,312}-cov]
# description = Run tests with coverage for {envname}
# commands =
#     pytest --cov=pyvoi --cov-report=xml --cov-report=term-missing --cov-fail-under=80 {posargs}

# Example for pre-commit to run all checks (can be slow)
# [testenv:precommit]
# description = Run all pre-commit hooks
# deps = pre-commit
# commands = pre-commit run --all-files

# Flake8, Black, isort are handled by Ruff, so no separate envs for them.

# If you had a clean environment:
# [testenv:clean]
# description = Clean up build artifacts and cache files
# deps = coverage
# commands =
#     coverage erase
#     python -c 'import shutil; shutil.rmtree(".tox", ignore_errors=True)'
#     python -c 'import shutil; shutil.rmtree(".pytest_cache", ignore_errors=True)'
#     python -c 'import shutil; shutil.rmtree(".mypy_cache", ignore_errors=True)'
#     python -c 'import shutil; shutil.rmtree("build", ignore_errors=True)'
#     python -c 'import shutil; shutil.rmtree("dist", ignore_errors=True)'
#     python -c 'import shutil; shutil.rmtree("pyvoi.egg-info", ignore_errors=True)'
#     python -c 'import shutil; shutil.rmtree("docs/_build", ignore_errors=True)'
#     python -c 'import glob, os; [os.remove(f) for f in glob.glob("*.pyc")] + [os.remove(f) for f in glob.glob("*.pyo")]'
