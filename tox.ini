[tox]
requires =
    tox>=4.2
env_list =
    py{312, 311, 310, 39, 38}  # Test against multiple Python versions
    min_versions             # Test with minimum dependency versions
    max_versions             # Test with maximum dependency versions
    lint                     # Linting and formatting checks
    typecheck                # Static type checking
    security                 # Security scanning
    docs                     # Build documentation
    coverage_report          # Generate coverage report (can be combined with test runs)
skip_missing_interpreters = true

[testenv]
description = Run pytest tests with {envname}
deps =
    .[all] # Install voiage with all its optional dependencies for thorough testing
    hypothesis>=6
    numpy>=1.20
    pandas>=1.3
    pytest>=7
    pytest-cov>=3
    scikit-learn>=1.0 # For EVPPI tests
commands =
    pytest {posargs} # Pass positional arguments to pytest (e.g., for specific test files)

[testenv:min_versions]
description = Test with minimum dependency versions
deps =
    .[all]
    hypothesis>=6.0,<7.0
    numpy>=1.20,<1.21
    pandas>=1.3,<1.4
    pytest>=7.0,<8.0
    pytest-cov>=3.0,<4.0
    scikit-learn>=1.0,<1.1
    scipy>=1.7,<1.8
commands =
    pytest {posargs}

[testenv:max_versions]
description = Test with maximum dependency versions
deps =
    .[all]
    hypothesis>=6.0,<7.0
    numpy>=1.26,<2.0
    pandas>=2.2,<3.0
    pytest>=7.0,<9.0
    pytest-cov>=3.0,<6.0
    scikit-learn>=1.4,<2.0
    scipy>=1.12,<1.15
commands =
    pytest {posargs}

[testenv:lint]
description = Run linters and formatters
deps =
    ruff==0.1.9 # Match version in pre-commit and pyproject.toml
commands =
    ruff check voiage tests --fix --exit-non-zero-on-fix # Lint and auto-fix, exit if fixes were made
    ruff format voiage tests --check # Check formatting, exit if not formatted

[testenv:typecheck]
description = Run static type checking with MyPy
deps =
    matplotlib>=3.4
    mypy>=1.8 # Match version in pre-commit and pyproject.toml
    numpy>=1.20
    pandas>=1.3
    pymc>=5
    scikit-learn>=1
    seaborn>=0.11
    statsmodels>=0.13
    typer>=0.9
    types-setuptools
    xarray>=0.19
commands =
    mypy voiage tests --config-file pyproject.toml {posargs}

[testenv:security]
description = Run security analysis with Bandit
deps =
    bandit>=1.7.6 # Match version in pre-commit
commands =
    bandit -r voiage -c pyproject.toml -s B101 {posargs} # Use config from pyproject.toml

[testenv:docs]
description = Build Sphinx documentation
deps =
    .[all]
    sphinx>=7
    sphinx-autodoc-typehints>=1.12
    sphinx-rtd-theme>=1
commands =
    sphinx-build -W -b html docs docs/_build/html {posargs} # -W: turn warnings into errors

[testenv:coverage_report]
description = Generate and check code coverage report
deps =
    coverage>=7.0 # pytest-cov uses coverage.py
commands =
    coverage report -m --fail-under=80 # Show missing lines and fail if below threshold
    coverage xml # Generate XML report for CI/CD systems (e.g., Codecov)
    coverage html -d coverage_html_report # Generate HTML report

[gh-actions]
python =
    3.8: py38
    3.9: py39
    3.10: py310
    3.11: py311
    3.12: py312