============================= test session starts ==============================
platform darwin -- Python 3.13.2, pytest-8.4.2, pluggy-1.6.0
benchmark: 5.2.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /Users/doughnut/GitHub/voiage
configfile: pyproject.toml
plugins: mock-3.15.1, asyncio-1.2.0, anyio-4.11.0, xdist-3.8.0, timeout-2.4.0, vcr-1.0.2, jaxtyping-0.3.2, dash-3.2.0, logfire-4.10.0, playwright-0.7.0, ipywidgets-1.49.0, hypothesis-6.143.0, benchmark-5.2.0, base-url-2.1.0, typeguard-4.4.4, cov-7.0.0, syrupy-5.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 39 items

test_phase2_integration.py FF.F...............F.FFF...........F..F       [100%]

=================================== FAILURES ===================================
__________________ TestHealthEconomics.test_qaly_calculation ___________________
test_phase2_integration.py:101: in test_qaly_calculation
    assert qaly <= 5.0  # Should not exceed time horizon
    ^^^^^^^^^^^^^^^^^^
E   assert Array(7.77545338, dtype=float64, weak_type=True) <= 5.0
__________________ TestHealthEconomics.test_cost_calculation ___________________
test_phase2_integration.py:115: in test_cost_calculation
    assert cost <= 6000.0  # Max possible cost
    ^^^^^^^^^^^^^^^^^^^^^
E   assert Array(17278.78528789, dtype=float64, weak_type=True) <= 6000.0
________________ TestHealthEconomics.test_net_monetary_benefit _________________
test_phase2_integration.py:126: in test_net_monetary_benefit
    assert isinstance(nmb, float)
E   assert False
E    +  where False = isinstance(Array(425969.63219714, dtype=float64, weak_type=True), float)
____________ TestClinicalTrialDesign.test_sample_size_optimization _____________
test_phase2_integration.py:453: in test_sample_size_optimization
    results = optimizer.optimize_sample_size(
voiage/clinical_trials.py:185: in optimize_sample_size
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:185: in <lambda>
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:149: in calculate_voi_per_participant
    power_increase = self._calculate_power_increase(sample_size, sample_size + 1)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:220: in _calculate_power_increase
    current_power = self._calculate_power_at_sample_size(current_size)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:231: in _calculate_power_at_sample_size
    if n_per_group <= 0:
       ^^^^^^^^^^^^^^^^
E   jax.errors.TracerBoolConversionError: Attempted boolean conversion of traced array with shape bool[].
E   This BatchTracer with object id 6130739504 was created on line:
E     /Users/doughnut/GitHub/voiage/voiage/clinical_trials.py:231:11 (VOIBasedSampleSizeOptimizer._calculate_power_at_sample_size)
E   See https://jax.readthedocs.io/en/latest/errors.html#jax.errors.TracerBoolConversionError
E   --------------------
E   For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.
___________ TestClinicalTrialDesign.test_complete_trial_optimization ___________
test_phase2_integration.py:483: in test_complete_trial_optimization
    results = optimizer.optimize_complete_design(self.treatment)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:541: in optimize_complete_design
    sample_size_results = self.sample_size_optimizer.optimize_sample_size(
voiage/clinical_trials.py:185: in optimize_sample_size
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:185: in <lambda>
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:149: in calculate_voi_per_participant
    power_increase = self._calculate_power_increase(sample_size, sample_size + 1)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:220: in _calculate_power_increase
    current_power = self._calculate_power_at_sample_size(current_size)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:231: in _calculate_power_at_sample_size
    if n_per_group <= 0:
       ^^^^^^^^^^^^^^^^
E   jax.errors.TracerBoolConversionError: Attempted boolean conversion of traced array with shape bool[].
E   This BatchTracer with object id 6131266672 was created on line:
E     /Users/doughnut/GitHub/voiage/voiage/clinical_trials.py:231:11 (VOIBasedSampleSizeOptimizer._calculate_power_at_sample_size)
E   See https://jax.readthedocs.io/en/latest/errors.html#jax.errors.TracerBoolConversionError
E   --------------------
E   For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.
____________ TestClinicalTrialDesign.test_trial_outcome_simulation _____________
test_phase2_integration.py:499: in test_trial_outcome_simulation
    optimized_design = optimizer.optimize_complete_design(self.treatment)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:541: in optimize_complete_design
    sample_size_results = self.sample_size_optimizer.optimize_sample_size(
voiage/clinical_trials.py:185: in optimize_sample_size
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:185: in <lambda>
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:149: in calculate_voi_per_participant
    power_increase = self._calculate_power_increase(sample_size, sample_size + 1)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:220: in _calculate_power_increase
    current_power = self._calculate_power_at_sample_size(current_size)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:231: in _calculate_power_at_sample_size
    if n_per_group <= 0:
       ^^^^^^^^^^^^^^^^
E   jax.errors.TracerBoolConversionError: Attempted boolean conversion of traced array with shape bool[].
E   This BatchTracer with object id 6131267536 was created on line:
E     /Users/doughnut/GitHub/voiage/voiage/clinical_trials.py:231:11 (VOIBasedSampleSizeOptimizer._calculate_power_at_sample_size)
E   See https://jax.readthedocs.io/en/latest/errors.html#jax.errors.TracerBoolConversionError
E   --------------------
E   For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.
____________ TestClinicalTrialDesign.test_quick_trial_optimization _____________
test_phase2_integration.py:512: in test_quick_trial_optimization
    results = quick_trial_optimization(
voiage/clinical_trials.py:823: in quick_trial_optimization
    return optimizer.optimize_complete_design(treatment, budget_constraint)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:541: in optimize_complete_design
    sample_size_results = self.sample_size_optimizer.optimize_sample_size(
voiage/clinical_trials.py:185: in optimize_sample_size
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:185: in <lambda>
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:149: in calculate_voi_per_participant
    power_increase = self._calculate_power_increase(sample_size, sample_size + 1)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:220: in _calculate_power_increase
    current_power = self._calculate_power_at_sample_size(current_size)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:231: in _calculate_power_at_sample_size
    if n_per_group <= 0:
       ^^^^^^^^^^^^^^^^
E   jax.errors.TracerBoolConversionError: Attempted boolean conversion of traced array with shape bool[].
E   This BatchTracer with object id 6131268304 was created on line:
E     /Users/doughnut/GitHub/voiage/voiage/clinical_trials.py:231:11 (VOIBasedSampleSizeOptimizer._calculate_power_at_sample_size)
E   See https://jax.readthedocs.io/en/latest/errors.html#jax.errors.TracerBoolConversionError
E   --------------------
E   For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.
____________ TestPhase2Integration.test_cross_module_functionality _____________
test_phase2_integration.py:713: in test_cross_module_functionality
    trial_results = optimizer.optimize_complete_design(treatment)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:541: in optimize_complete_design
    sample_size_results = self.sample_size_optimizer.optimize_sample_size(
voiage/clinical_trials.py:185: in optimize_sample_size
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:185: in <lambda>
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:149: in calculate_voi_per_participant
    power_increase = self._calculate_power_increase(sample_size, sample_size + 1)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:220: in _calculate_power_increase
    current_power = self._calculate_power_at_sample_size(current_size)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:231: in _calculate_power_at_sample_size
    if n_per_group <= 0:
       ^^^^^^^^^^^^^^^^
E   jax.errors.TracerBoolConversionError: Attempted boolean conversion of traced array with shape bool[].
E   This BatchTracer with object id 6131599984 was created on line:
E     /Users/doughnut/GitHub/voiage/voiage/clinical_trials.py:231:11 (VOIBasedSampleSizeOptimizer._calculate_power_at_sample_size)
E   See https://jax.readthedocs.io/en/latest/errors.html#jax.errors.TracerBoolConversionError
E   --------------------
E   For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.
______________ TestPhase2Integration.test_comprehensive_workflow _______________
test_phase2_integration.py:810: in test_comprehensive_workflow
    trial_results = trial_optimizer.optimize_complete_design(new_treatment)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:541: in optimize_complete_design
    sample_size_results = self.sample_size_optimizer.optimize_sample_size(
voiage/clinical_trials.py:185: in optimize_sample_size
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:185: in <lambda>
    voi_per_participant = vmap(lambda n: self.calculate_voi_per_participant(treatment, n))(sample_sizes)
                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:149: in calculate_voi_per_participant
    power_increase = self._calculate_power_increase(sample_size, sample_size + 1)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:220: in _calculate_power_increase
    current_power = self._calculate_power_at_sample_size(current_size)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
voiage/clinical_trials.py:231: in _calculate_power_at_sample_size
    if n_per_group <= 0:
       ^^^^^^^^^^^^^^^^
E   jax.errors.TracerBoolConversionError: Attempted boolean conversion of traced array with shape bool[].
E   This BatchTracer with object id 6135155024 was created on line:
E     /Users/doughnut/GitHub/voiage/voiage/clinical_trials.py:231:11 (VOIBasedSampleSizeOptimizer._calculate_power_at_sample_size)
E   See https://jax.readthedocs.io/en/latest/errors.html#jax.errors.TracerBoolConversionError
E   --------------------
E   For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.
================================ tests coverage ================================
_______________ coverage: platform darwin, python 3.13.2-final-0 _______________

Name                                         Stmts   Miss  Cover   Missing
--------------------------------------------------------------------------
voiage/analysis.py                             412    375     9%   26-27, 36-39, 56-98, 116-147, 158-172, 176-180, 193-196, 206-208, 212-216, 231-273, 277-297, 306-333, 343-346, 356-359, 397-485, 499-530, 579-749, 790-874, 888-910, 914-933
voiage/backends/__init__.py                      5      5     0%   5-18
voiage/backends/advanced_integration.py         23     23     0%   5-43
voiage/backends/advanced_jax_regression.py      57     57     0%   2-92
voiage/backends/enhanced_jax_backend.py         85     85     0%   4-149
voiage/backends/gpu_acceleration.py             33     33     0%   3-65
voiage/backends/performance_profiler.py         48     48     0%   3-95
voiage/cli.py                                   44     44     0%   11-172
voiage/clinical_trials.py                      322    145    55%   186-200, 229, 232, 259-265, 348-355, 359-381, 389-410, 420, 429, 467-474, 478-485, 490-491, 496, 545-571, 587-615, 634-663, 667-691, 696-698, 703-705, 709-715, 719-723, 729-748, 815-820
voiage/config_objects.py                       161    161     0%   3-300
voiage/core/gpu_acceleration.py                176    176     0%   3-378
voiage/core/io.py                               59     59     0%   3-140
voiage/core/memory_optimization.py             144    144     0%   3-372
voiage/core/utils.py                            60     53    12%   39-77, 113-185, 205-221
voiage/ecosystem_integration.py                301    187    38%   59-107, 119-154, 158-183, 207-246, 260-328, 340-365, 391-411, 446, 479-494, 498-521, 525, 683-684, 718, 760-761, 784-797, 807, 810-811, 813-815, 876-877, 883-884, 890-891, 896-899
voiage/environmental/__init__.py                 2      2     0%   3-11
voiage/environmental/impact_assessment.py       48     48     0%   3-171
voiage/factory.py                               30     30     0%   3-305
voiage/financial/__init__.py                     2      2     0%   3-11
voiage/financial/risk_analysis.py               68     68     0%   3-224
voiage/fluent.py                                53     53     0%   3-249
voiage/health_economics.py                     153     33    78%   73, 96, 106, 136, 222-237, 357, 403-423, 427-445, 470, 507, 516
voiage/healthcare/__init__.py                    2      2     0%   3-11
voiage/healthcare/utilities.py                  86     86     0%   3-235
voiage/hta_integration.py                      323     67    79%   201, 214-215, 220-221, 223-224, 231-237, 242-247, 254-255, 262-264, 268-271, 277-279, 285, 340-342, 351-352, 358-359, 413-420, 424-429, 449, 465, 487-489, 540, 545, 550, 562, 564, 636, 638, 642, 657, 676, 717
voiage/main_backends.py                        263    221    16%   19, 28-45, 55-58, 67, 84-85, 93-105, 109-137, 142-199, 207-260, 264-275, 279-298, 303-329, 334-346, 351-411, 422-457, 461, 465-468, 472-477, 487-490, 498-511, 515-517, 539-545, 551-553
voiage/metamodels.py                           551    551     0%   5-1152
voiage/methods/adaptive.py                     221    221     0%   53-724
voiage/methods/basic.py                         55     55     0%   9-160
voiage/methods/calibration.py                  117    117     0%   53-496
voiage/methods/network_nma.py                  214    214     0%   52-812
voiage/methods/observational.py                 90     90     0%   54-406
voiage/methods/portfolio.py                    116    116     0%   48-402
voiage/methods/sample_information.py           113    113     0%   8-245
voiage/methods/sequential.py                    99     99     0%   12-299
voiage/methods/structural.py                   141    141     0%   17-389
voiage/multi_domain.py                         279     80    71%   184, 201-216, 220-229, 242, 255, 297, 334, 374, 413, 417, 430, 443, 456, 490-522, 534-568, 572-590, 596, 604-627, 657, 662-672
voiage/parallel/__init__.py                      2      2     0%   3-9
voiage/parallel/monte_carlo.py                 119    119     0%   3-336
voiage/plot/ceac.py                             59     59     0%   3-156
voiage/plot/voi_curves.py                      142    142     0%   5-364
voiage/schema.py                               210    142    32%   23-25, 36-45, 52, 57-59, 64, 69, 74, 89-112, 126-154, 167-170, 177, 182-184, 189, 194, 209-253, 267-310, 338-341, 364-372, 379, 407-412, 438-457, 482-487
voiage/stats.py                                 11     11     0%   5-48
--------------------------------------------------------------------------
TOTAL                                         5542   4479    19%

6 files skipped due to complete coverage.
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED test_phase2_integration.py::TestHealthEconomics::test_qaly_calculation
FAILED test_phase2_integration.py::TestHealthEconomics::test_cost_calculation
FAILED test_phase2_integration.py::TestHealthEconomics::test_net_monetary_benefit
FAILED test_phase2_integration.py::TestClinicalTrialDesign::test_sample_size_optimization
FAILED test_phase2_integration.py::TestClinicalTrialDesign::test_complete_trial_optimization
FAILED test_phase2_integration.py::TestClinicalTrialDesign::test_trial_outcome_simulation
FAILED test_phase2_integration.py::TestClinicalTrialDesign::test_quick_trial_optimization
FAILED test_phase2_integration.py::TestPhase2Integration::test_cross_module_functionality
FAILED test_phase2_integration.py::TestPhase2Integration::test_comprehensive_workflow
========================= 9 failed, 30 passed in 8.02s =========================
